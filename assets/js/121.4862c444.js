(window.webpackJsonp=window.webpackJsonp||[]).push([[121],{441:function(s,t,a){"use strict";a.r(t);var n=a(7),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"vue单页应用刷新网页后vuex的state数据丢失的解决方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#vue单页应用刷新网页后vuex的state数据丢失的解决方案"}},[s._v("#")]),s._v(" vue单页应用刷新网页后vuex的state数据丢失的解决方案")]),s._v(" "),t("h2",{attrs:{id:"产生原因"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#产生原因"}},[s._v("#")]),s._v(" 产生原因")]),s._v(" "),t("p",[s._v("javascript代码是运行在内存中的，代码运行时的所有变量，函数也都是保存在内存中的。刷新页面，以前申请的内存被释放掉，重新加载脚本代码，变量重新赋值，所以，这些数据要存储就必须存储在外部，如，localStorage，sessionStorage，indexDB等，这些浏览器提供的API，让你可以将数据存储在硬盘上，做持久化存储。")]),s._v(" "),t("p",[s._v("因为store里的数据是保存在运行内存中的,当页面刷新时，页面会重新加载vue实例，store里面的数据就会被重新赋值。")]),s._v(" "),t("h2",{attrs:{id:"解决思路"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解决思路"}},[s._v("#")]),s._v(" 解决思路")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("1、一种是state里的数据全部是通过请求来触发action或mutation来改变")])]),s._v(" "),t("li",[t("p",[s._v("2、一种是将state里的数据保存一份到本地存储(localStorage、sessionStorage、cookie）中")])])]),s._v(" "),t("p",[s._v("很显然，第一种方案基本不可行，除非项目很小或者vuex存储的数据很少。而第二种可以保证刷新页面数据不丢失且易于读取。")]),s._v(" "),t("h2",{attrs:{id:"解决过程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解决过程"}},[s._v("#")]),s._v(" 解决过程")]),s._v(" "),t("p",[s._v("首先得选择合适的客户端存储")]),s._v(" "),t("p",[t("code",[s._v("localStorage")]),s._v("是永久存储在本地，除非你主动去删除;")]),s._v(" "),t("p",[t("code",[s._v("sessionStorage")]),s._v("是存储到当前页面关闭为止;")]),s._v(" "),t("p",[t("code",[s._v("cookie")]),s._v("则根据你设置的有效时间来存储，但缺点是不能储存大数据且不易读取。")]),s._v(" "),t("p",[s._v("我选择的是"),t("code",[s._v("sessionStorage")]),s._v(",选择的原因vue是单页面应用，操作都是在一个页面跳转路由，另一个原因是"),t("code",[s._v("sessionStorage")]),s._v("可以保证打开页面时"),t("code",[s._v("sessionStorage")]),s._v("的数据为空，而如果是localStorage则会读取上一次打开页面的数据。")]),s._v(" "),t("p",[s._v("然后是怎么用"),t("code",[s._v("sessionStorage")]),s._v("来保存state里的数据。")]),s._v(" "),t("p",[s._v("第一种方案")]),s._v(" "),t("p",[s._v("由于"),t("code",[s._v("state")]),s._v("里的数据是响应式，所以"),t("code",[s._v("sessionStorage")]),s._v("存储也要跟随变化。又由于vuex规定所有state里数据必须通过mutation方法来修改，所以第一种方案就是mutation修改state的同时修改"),t("code",[s._v("sessionStorage")]),s._v("对应存储的属性")]),s._v(" "),t("p",[s._v("第二种方案")]),s._v(" "),t("p",[s._v("第一种方案确实可以解决问题，但这种方法很明显让人觉得怪异，都这样了，那不如直接用"),t("code",[s._v("sessionStorage")]),s._v("来做状态管理。")]),s._v(" "),t("p",[s._v("那怎么才能不用每次修改"),t("code",[s._v("state")]),s._v("时同时也要修改"),t("code",[s._v("sessionStorage")]),s._v("呢？这时我们可以换一个思路，因为我们是只有在刷新页面时才会丢失state里的数据，那有没有办法在点击页面刷新时先将state数据保存到"),t("code",[s._v("sessionStorage")]),s._v(",然后才真正刷新页面?")]),s._v(" "),t("p",[s._v("当然有，"),t("code",[s._v("beforeunload")]),s._v("这个事件在页面刷新时先触发的。那这个事件应该在哪里触发呢？我们总不能每个页面都监听这个事件，所以我选择放在"),t("code",[s._v("app.vue")]),s._v("这个入口组件中，这样就可以保证每次刷新页面都可以触发。")]),s._v(" "),t("h2",{attrs:{id:"具体实现"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#具体实现"}},[s._v("#")]),s._v(" 具体实现")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" default "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  name: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'App'")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("created")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    //在页面加载时读取sessionStorage里的状态信息\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sessionStorage.getItem"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"store"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        this."),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$store")]),s._v(".replaceState"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Object.assign"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(", this."),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$store")]),s._v(".state,JSON.parse"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sessionStorage.getItem"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"store"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" \n\n    //在页面刷新时将vuex里的信息保存到sessionStorage里\n    window.addEventListener"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"beforeunload"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        sessionStorage.setItem"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"store"')]),s._v(",JSON.stringify"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("this."),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$store")]),s._v(".state"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("应用背景是用户登入后保存状态，退出后移除状态")]),s._v(" "),t("p",[s._v("mutations.js")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("ADD_LOGIN_USER "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("state,data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("  //登入，保存状态\n  sessionStorage.setItem"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),s._v(", data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  //添加到sessionStorage\n  sessionStorage.setItem"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"isLogin"')]),s._v(",true"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("state.username")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("data,             //同步的改变store中的状态\n  "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("state.isLogin")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\nSIGN_OUT "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("state"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("   //退出，删除状态\n  sessionStorage.removeItem"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  //移除sessionStorage\n  sessionStorage.removeItem"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"isLogin"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("state.username")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),s._v("                //同步的改变story中的状态\n  "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("state.isLogin")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("getters.js")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("isLogin "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("state"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("state.isLogin"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("    \n      "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("state.isLogin")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sessionStorage.getItem"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'isLogin'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   //从sessionStorage中读取状态\n      "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("state.username")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sessionStorage.getItem"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'username'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" state.username\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);